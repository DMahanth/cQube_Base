- name: Creates directory
  file: path=~/nifi state=directory

- name: Installing curl
  apt: name=curl

- name: Download NiFi
  get_url:
    url: https://archive.apache.org/dist/nifi/1.10.0/nifi-1.10.0-bin.tar.gz
    dest: ~/nifi

- name: Check if nifi is present in /opt
  stat: path=/opt/nifi
  register: status

- name: stop nifi if its running
  shell: /opt/nifi/bin/nifi.sh stop
  when: status.stat.exists == true

- name: remove nifi directory if present
  become: yes
  shell: rm -rf /opt/nifi
  ignore_errors: yes
  args:
    warn: false

- name: Extract NiFi in the same folder
  unarchive:
    src: ~/nifi/nifi-1.10.0-bin.tar.gz
    dest: /opt

- name: Rename the extracted folder
  shell: mv /opt/nifi* /opt/nifi

- name: Creates directory
  file: path=/opt/nifi/jars state=directory

- name: Download Jar file
  get_url:
    url: https://repo1.maven.org/maven2/org/postgresql/postgresql/42.2.10/postgresql-42.2.10.jar
    dest: /opt/nifi/jars/

- name: configure the webserver in nifi.properties file
  replace:
    dest: /opt/nifi/conf/nifi.properties
    regexp: 'nifi.web.http.host='
    replace: 'nifi.web.http.host=0.0.0.0'

- name: configure the webserver in nifi.properties file
  replace:
    dest: /opt/nifi/conf/nifi.properties
    regexp: 'nifi.web.http.port=8080'
    replace: 'nifi.web.http.port={{ nifi_port }}'

- name: Increase nifi memory
  replace:
    dest: /opt/nifi/conf/bootstrap.conf
    regexp: "java.arg.2=-Xms512m"
    replace: "java.arg.2={{ java_arg_2 }}"

- name: Add time zone to nifi
  blockinfile:
        path: /opt/nifi/conf/bootstrap.conf
        block: |
               java.arg.8=-Duser.timezone=Asia/Kolkata

- name: Increase nifi memory
  replace:
    dest: /opt/nifi/conf/bootstrap.conf
    regexp: "java.arg.3=-Xmx512m"
    replace: "java.arg.3={{ java_arg_3 }}"

- name: start NiFi
  shell: /opt/nifi/bin/nifi.sh start
- pause:
    minutes: 3
    prompt: "nifi is starting, kindly do not press any key"

- name: Get configuration details
  uri:
    url: http://localhost:{{ nifi_port }}/nifi-api/controller/config
    method: GET
  register: nifi_config  
    
- name: Update the NiFi thread count
  uri:
    url: http://localhost:{{ nifi_port }}/nifi-api/controller/config
    method: PUT
    body_format: json
    body: {"revision":{"version":"{{ nifi_config.json.revision.version }}"},"component":{"maxTimerDrivenThreadCount":"100","maxEventDrivenThreadCount":"100"}}
